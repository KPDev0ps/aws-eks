# ARCHIVED: This workflow has been split into separate plan and apply workflows
# - terraform-plan.yml: For plan-only on PRs
# - terraform-apply.yml: For plan+apply on main branch pushes with auto branch cleanup
#
# This file is kept for reference but is no longer active.
# You can delete this file after confirming the new workflows work correctly.

name: "[ARCHIVED] Terraform Plan & Deploy"

# DISABLED: This workflow has been replaced by terraform-plan.yml and terraform-apply.yml
# All triggers have been commented out to prevent execution

# on:
#   push:
#     branches: [main]
#     paths:
#       - 'terraform/aws/overlay/**'
#       - '.github/workflows/**'
#       - '.github/actions/**'
#   
#   pull_request:
#     branches: [main]
#     paths:
#       - 'terraform/aws/overlay/**'
#       - '.github/workflows/**'
#       - '.github/actions/**'
#   
#   workflow_dispatch:
#     inputs:
#       environments:
#         description: 'Environments to target (comma-separated: dev,staging,prod or "all")'
#         required: true
#         default: 'dev'
#         type: string
#       action:
#         description: 'Action to perform'
#         required: true
#         default: 'plan'
#         type: choice
#         options:
#           - plan
#           - apply
#           - plan-and-apply
#       force_all_environments:
#         description: 'Run for all environments regardless of changes'
#         required: false
#         default: false
#         type: boolean

permissions:
  id-token: write
  contents: read
  pull-requests: write
  issues: write
  checks: write

env:
  AWS_REGION: us-east-2
  TF_VERSION: "1.8.0"

concurrency:
  group: terraform-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  detect-changes:
    name: "ðŸ” Detect Changes"
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.get-changes.outputs.matrix }}
      has_changes: ${{ steps.get-changes.outputs.has_changes }}
      environments: ${{ steps.get-changes.outputs.environments }}
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸŽ¯ Get changed Terraform directories
        id: get-changes
        uses: ./.github/actions/tf-matrix
        with:
          filter: terraform/aws/overlay/**
      
      - name: ðŸ› ï¸ Handle manual workflow dispatch
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ðŸ“‹ Manual workflow dispatch detected"
          
          # Parse environments input
          if [ "${{ github.event.inputs.environments }}" = "all" ]; then
            environments='["dev","staging","prod"]'
          else
            # Convert comma-separated to JSON array
            envs=$(echo "${{ github.event.inputs.environments }}" | tr ',' '\n' | sed 's/^/"/;s/$/"/' | paste -sd,)
            environments="[$envs]"
          fi
          
          # Build matrix for manual dispatch
          matrix_items=""
          for env in $(echo "$environments" | jq -r '.[]'); do
            if [ ! -z "$matrix_items" ]; then
              matrix_items="$matrix_items,"
            fi
            matrix_items="$matrix_items{\"environment\":\"$env\",\"terraform_dir\":\"terraform/aws/overlay/$env/eks\"}"
          done
          
          matrix_json="{\"include\":[$matrix_items]}"
          
          echo "ðŸŽ¯ Manual dispatch matrix: $matrix_json"
          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "environments=$environments" >> $GITHUB_OUTPUT

  terraform-plan:
    name: "ðŸ“‹ Plan (${{ matrix.environment }})"
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    outputs:
      plan-${{ matrix.environment }}: ${{ steps.plan.outputs.exitcode }}
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ›¡ï¸ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: "${{ secrets.OIDC_ROLE_ARN }}"
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 3600
      
      - name: ðŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
      
      - name: ðŸ“‹ Cache Terraform
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-terraform-${{ matrix.environment }}-${{ hashFiles(format('{0}/.terraform.lock.hcl', matrix.terraform_dir)) }}
          restore-keys: |
            ${{ runner.os }}-terraform-${{ matrix.environment }}-
      
      - name: ðŸ”§ Terraform Init
        working-directory: ${{ matrix.terraform_dir }}
        run: |
          echo "ðŸ”§ Initializing Terraform for ${{ matrix.environment }}..."
          terraform init
          
      - name: ðŸŽ¨ Terraform Format Check
        working-directory: ${{ matrix.terraform_dir }}
        run: |
          echo "ðŸŽ¨ Checking Terraform format for ${{ matrix.environment }}..."
          if ! terraform fmt -check -diff; then
            echo "âŒ Format check failed for ${{ matrix.environment }}"
            echo "ðŸ’¡ Run: terraform fmt -recursive"
            exit 1
          fi
          
      - name: âœ… Terraform Validate
        working-directory: ${{ matrix.terraform_dir }}
        run: |
          echo "âœ… Validating Terraform configuration for ${{ matrix.environment }}..."
          terraform validate
          
      - name: ðŸ“‹ Terraform Plan
        id: plan
        working-directory: ${{ matrix.terraform_dir }}
        continue-on-error: true
        run: |
          echo "ðŸ“‹ Creating Terraform plan for ${{ matrix.environment }}..."
          
          terraform plan \
            -detailed-exitcode \
            -out=tfplan-${{ matrix.environment }}-${{ github.run_number }}.tfplan \
            -input=false
          
          exit_code=$?
          echo "exitcode=$exit_code" >> $GITHUB_OUTPUT
          
          # Generate human readable plan
          terraform show -no-color tfplan-${{ matrix.environment }}-${{ github.run_number }}.tfplan > plan-output.txt
          
          if [ $exit_code -eq 1 ]; then
            echo "âŒ Plan failed for ${{ matrix.environment }}"
            exit 1
          elif [ $exit_code -eq 2 ]; then
            echo "ðŸ“‹ Plan shows changes for ${{ matrix.environment }}"
          else
            echo "âœ… No changes needed for ${{ matrix.environment }}"
          fi
      
      - name: ðŸ“¤ Upload Plan Artifact
        if: steps.plan.outputs.exitcode == '2'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ matrix.environment }}-${{ github.run_number }}
          path: |
            ${{ matrix.terraform_dir }}/tfplan-${{ matrix.environment }}-${{ github.run_number }}.tfplan
            ${{ matrix.terraform_dir }}/plan-output.txt
          retention-days: 30
      
      - name: ðŸ’¬ Comment Plan on PR
        if: github.event_name == 'pull_request' && steps.plan.outputs.exitcode == '2'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('${{ matrix.terraform_dir }}/plan-output.txt', 'utf8');
            const truncatedOutput = planOutput.length > 10000 ? 
              planOutput.substring(0, 10000) + '\n\n... (truncated)' : planOutput;
            
            const comment = `## ðŸ“‹ Terraform Plan: \`${{ matrix.environment }}\`
            
            <details>
            <summary>ðŸ“Š Plan Output (click to expand)</summary>
            
            \`\`\`terraform
            ${truncatedOutput}
            \`\`\`
            </details>
            
            **Plan Status:** ${{ steps.plan.outputs.exitcode == '2' && 'ðŸ“‹ Changes detected' || 'âœ… No changes' }}
            **Environment:** \`${{ matrix.environment }}\`
            **Workflow:** [\`${{ github.workflow }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  terraform-apply:
    name: "ðŸš€ Apply (${{ matrix.environment }})"
    runs-on: ubuntu-latest
    needs: [detect-changes, terraform-plan]
    if: |
      always() &&
      needs.detect-changes.outputs.has_changes == 'true' &&
      needs.terraform-plan.result == 'success' &&
      (
        github.event.inputs.action == 'apply' || 
        github.event.inputs.action == 'plan-and-apply' ||
        (github.event_name == 'push' && github.ref == 'refs/heads/main')
      )
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    environment: 
      name: ${{ matrix.environment }}
      url: "https://console.aws.amazon.com/eks/home?region=${{ env.AWS_REGION }}#/clusters"
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ›¡ï¸ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: "${{ secrets.OIDC_ROLE_ARN }}"
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 3600
      
      - name: ðŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
      
      - name: ðŸ“‹ Cache Terraform
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-terraform-${{ matrix.environment }}-${{ hashFiles(format('{0}/.terraform.lock.hcl', matrix.terraform_dir)) }}
      
      - name: ðŸ”§ Terraform Init
        working-directory: ${{ matrix.terraform_dir }}
        run: |
          echo "ðŸ”§ Initializing Terraform for ${{ matrix.environment }}..."
          terraform init
      
      - name: ðŸ“¥ Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-${{ matrix.environment }}-${{ github.run_number }}
          path: ${{ matrix.terraform_dir }}
      
      - name: ðŸš€ Terraform Apply
        id: apply
        working-directory: ${{ matrix.terraform_dir }}
        run: |
          echo "ðŸš€ Applying Terraform plan for ${{ matrix.environment }}..."
          
          terraform apply \
            -input=false \
            -auto-approve \
            tfplan-${{ matrix.environment }}-${{ github.run_number }}.tfplan
          
          echo "âœ… Apply completed successfully for ${{ matrix.environment }}"
      
      - name: ðŸ“Š Post-Apply Summary
        working-directory: ${{ matrix.terraform_dir }}
        run: |
          echo "## ðŸš€ Apply Summary: ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Successfully applied" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${{ matrix.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**AWS Region:** \`${{ env.AWS_REGION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Terraform Directory:** \`${{ matrix.terraform_dir }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get cluster info if EKS cluster was created/updated
          if terraform output -json cluster_name > /dev/null 2>&1; then
            cluster_name=$(terraform output -raw cluster_name)
            echo "**EKS Cluster:** \`$cluster_name\`" >> $GITHUB_STEP_SUMMARY
            echo "**Console:** [View in AWS Console](https://console.aws.amazon.com/eks/home?region=${{ env.AWS_REGION }}#/clusters/$cluster_name)" >> $GITHUB_STEP_SUMMARY
          fi

  notify-completion:
    name: "ðŸ“¢ Notify Completion"
    runs-on: ubuntu-latest
    needs: [detect-changes, terraform-plan, terraform-apply]
    if: always() && needs.detect-changes.outputs.has_changes == 'true'
    
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸŽ¯ Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          environments=$(echo '${{ needs.detect-changes.outputs.environments }}' | jq -r '.[]')
          
          echo "### ðŸ“‹ Plan Results:" >> $GITHUB_STEP_SUMMARY
          plan_result="${{ needs.terraform-plan.result }}"
          if [ "$plan_result" = "success" ]; then
            echo "- âœ… **Plan:** Successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Plan:** Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Apply Results:" >> $GITHUB_STEP_SUMMARY
          apply_result="${{ needs.terraform-apply.result }}"
          
          if [ "$apply_result" = "success" ]; then
            echo "- âœ… **Apply:** Successful" >> $GITHUB_STEP_SUMMARY
          elif [ "$apply_result" = "skipped" ]; then
            echo "- â­ï¸ **Apply:** Skipped (plan-only or no changes)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Apply:** Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Processed Environments:" >> $GITHUB_STEP_SUMMARY
          for env in $environments; do
            echo "- \`$env\`" >> $GITHUB_STEP_SUMMARY
          done