name: "ğŸ” Terraform Validation & Security"

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'terraform/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'terraform/**'
      - '.github/workflows/**'
  schedule:
    # Run weekly drift detection
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      deep_scan:
        description: 'Run deep security scan'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pull-requests: write
  security-events: write
  issues: write

env:
  TF_VERSION: "1.8.0"

jobs:
  detect-changes:
    name: "ğŸ” Detect Changed Environments"
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.get-changes.outputs.matrix }}
      has_changes: ${{ steps.get-changes.outputs.has_changes }}
      environments: ${{ steps.get-changes.outputs.environments }}
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ¯ Get changed Terraform directories
        id: get-changes
        uses: ./.github/actions/tf-matrix
        with:
          filter: terraform/aws/overlay/**

  code-quality:
    name: "ğŸ¨ Code Quality & Format"
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: ğŸ“‹ Cache Terraform
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-terraform-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-terraform-

      - name: ğŸ¨ Terraform Format Check
        id: fmt
        run: |
          echo "## ğŸ¨ Terraform Format Check" >> $GITHUB_STEP_SUMMARY
          
          if terraform fmt -check -recursive -diff; then
            echo "âœ… All files are properly formatted" >> $GITHUB_STEP_SUMMARY
            echo "fmt_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Files need formatting. Run: \`terraform fmt -recursive\`" >> $GITHUB_STEP_SUMMARY
            echo "fmt_status=failed" >> $GITHUB_OUTPUT
            
            # Show detailed diff for PR comment
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              echo "FORMAT_DIFF<<EOF" >> $GITHUB_ENV
              terraform fmt -check -recursive -diff >> $GITHUB_ENV
              echo "EOF" >> $GITHUB_ENV
            fi
            exit 1
          fi
          
      - name: ğŸ“ Comment Format Issues on PR
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const diff = process.env.FORMAT_DIFF;
            const comment = `## ğŸ¨ Terraform Format Check Failed
            
            The following files need to be formatted:
            
            \`\`\`diff
            ${diff}
            \`\`\`
            
            **Fix:** Run \`terraform fmt -recursive\` in your local repository.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  validate-environments:
    name: "âœ… Validate (${{ matrix.environment }})"
    runs-on: ubuntu-latest
    needs: [detect-changes, code-quality]
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        include: ${{ fromJson(needs.detect-changes.outputs.matrix).include }}
      fail-fast: false
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          
      - name: ğŸ“‹ Cache Terraform
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-terraform-${{ hashFiles('**/.terraform.lock.hcl') }}
          
      - name: ğŸ¯ Terraform Init
        working-directory: terraform/aws/overlay/${{ matrix.environment }}/eks
        run: |
          terraform init -backend=false
          
      - name: âœ… Terraform Validate
        working-directory: terraform/aws/overlay/${{ matrix.environment }}/eks
        run: |
          terraform validate
          echo "âœ… ${{ matrix.environment }} validation successful" >> $GITHUB_STEP_SUMMARY
          
      - name: ğŸ” Configuration Lint
        working-directory: terraform/aws/overlay/${{ matrix.environment }}/eks
        run: |
          # Check for common issues
          echo "ğŸ” Linting ${{ matrix.environment }} configuration..."
          
          # Check for hardcoded values in Terraform files only (exclude .terraform and docs)
          if find . -name "*.tf" -o -name "*.tfvars" | xargs grep -l "803103365620" 2>/dev/null; then
            echo "âŒ Found hardcoded account IDs in ${{ matrix.environment }}"
            exit 1
          fi
          
          # Check for TODO/FIXME/HACK comments that might indicate incomplete configuration
          if find . -name "*.tf" -o -name "*.tfvars" | xargs grep -i "TODO\|FIXME\|HACK" 2>/dev/null; then
            echo "âš ï¸ Found TODO/FIXME/HACK comments in ${{ matrix.environment }}"
          fi
          
          # Check for environment-specific naming
          if ! grep -q "${{ matrix.environment }}" terraform.tfvars; then
            echo "âŒ Environment name not found in terraform.tfvars for ${{ matrix.environment }}"
            exit 1
          fi
          
          echo "âœ… Configuration lint passed for ${{ matrix.environment }}"

  security-comprehensive:
    name: "ğŸ” Comprehensive Security Scan"
    runs-on: ubuntu-latest
    needs: validate-environments
    strategy:
      matrix:
        tool: [trivy, checkov, tfsec]
      fail-fast: false
      
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ›¡ï¸ Run Trivy Security Scan
        if: matrix.tool == 'trivy'
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'terraform/'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          
      - name: ğŸ” Run Checkov Security Scan
        if: matrix.tool == 'checkov'
        uses: bridgecrewio/checkov-action@master
        with:
          directory: terraform/
          framework: terraform
          output_format: cli,sarif
          output_file_path: console,checkov-results.sarif
          soft_fail: true
          
      - name: ğŸ”’ Run TFSec Security Scan
        if: matrix.tool == 'tfsec'
        uses: aquasecurity/tfsec-sarif-action@master
        with:
          sarif_file: tfsec-results.sarif
          working_directory: terraform/
          
      - name: ğŸ“¤ Upload Security Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: ${{ matrix.tool }}-results.sarif
          category: ${{ matrix.tool }}

  compliance-check:
    name: "ğŸ“‹ Compliance & Best Practices"
    runs-on: ubuntu-latest
    needs: validate-environments
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ—ï¸ Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          
      - name: ğŸ” AWS Config Rules Check
        run: |
          echo "## ğŸ“‹ Compliance Check Results" >> $GITHUB_STEP_SUMMARY
          
          # Check for required tags
          echo "### ğŸ·ï¸ Tag Compliance:" >> $GITHUB_STEP_SUMMARY
          
          for env in dev staging prod; do
            cd terraform/aws/overlay/$env/eks
            
            required_tags=("Environment" "Terraform" "Project")
            missing_tags=""
            
            for tag in "${required_tags[@]}"; do
              if ! grep -q "\"$tag\"" *.tf; then
                missing_tags="$missing_tags $tag"
              fi
            done
            
            if [ -z "$missing_tags" ]; then
              echo "- âœ… $env: All required tags present" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âŒ $env: Missing tags:$missing_tags" >> $GITHUB_STEP_SUMMARY
            fi
            
            cd - > /dev/null
          done
          
          # Check for encryption settings
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”’ Encryption Compliance:" >> $GITHUB_STEP_SUMMARY
          
          if grep -r "encrypted.*true" terraform/; then
            echo "- âœ… EBS encryption enabled" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ EBS encryption status unclear" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for backup configurations
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ’¾ Business Continuity:" >> $GITHUB_STEP_SUMMARY
          echo "- â„¹ï¸ Manual verification required for backup strategies" >> $GITHUB_STEP_SUMMARY

  cost-analysis:
    name: "ğŸ’° Cost Analysis"
    runs-on: ubuntu-latest
    needs: validate-environments
    if: github.event_name == 'pull_request' || github.event.inputs.deep_scan == 'true'
    strategy:
      matrix:
        environment: [dev, staging, prod]
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ—ï¸ Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
          
      - name: ğŸ’° Setup Infracost
        uses: infracost/actions/setup@v2
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}
          
      - name: ğŸ“Š Generate Cost Estimate
        working-directory: terraform/aws/overlay/${{ matrix.environment }}/eks
        continue-on-error: true
        run: |
          # Initialize without backend for cost estimation
          terraform init -backend=false
          
          infracost breakdown --path . \
            --format json \
            --out-file /tmp/infracost-${{ matrix.environment }}.json
            
          infracost output --path /tmp/infracost-${{ matrix.environment }}.json \
            --format table \
            --out-file /tmp/infracost-${{ matrix.environment }}.txt
            
      - name: ğŸ“¤ Upload Cost Analysis
        uses: actions/upload-artifact@v4
        with:
          name: cost-analysis-${{ matrix.environment }}
          path: /tmp/infracost-${{ matrix.environment }}.*
          retention-days: 30

  documentation-check:
    name: "ğŸ“š Documentation & Standards"
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ“š Check Documentation
        run: |
          echo "## ğŸ“š Documentation Check" >> $GITHUB_STEP_SUMMARY
          
          # Check for README files
          readme_count=$(find terraform/ -name "README.md" | wc -l)
          echo "- ğŸ“„ README files found: $readme_count" >> $GITHUB_STEP_SUMMARY
          
          # Check for variable descriptions
          undocumented_vars=$(grep -r "variable \"" terraform/ | grep -v "description" | wc -l)
          if [ "$undocumented_vars" -eq 0 ]; then
            echo "- âœ… All variables have descriptions" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ $undocumented_vars variables missing descriptions" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for output descriptions
          undocumented_outputs=$(grep -r "output \"" terraform/ | grep -v "description" | wc -l)
          if [ "$undocumented_outputs" -eq 0 ]; then
            echo "- âœ… All outputs have descriptions" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ $undocumented_outputs outputs missing descriptions" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check for CHANGELOG
          if [ -f "CHANGELOG.md" ]; then
            echo "- âœ… CHANGELOG.md exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ CHANGELOG.md missing" >> $GITHUB_STEP_SUMMARY
          fi

  dependency-scan:
    name: "ğŸ” Dependency Security Scan"
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ” Scan for Vulnerable Dependencies
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'dependency-results.sarif'
          
      - name: ğŸ“¤ Upload Dependency Scan Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'dependency-results.sarif'

  pr-summary:
    name: "ğŸ“‹ PR Summary"
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [code-quality, validate-environments, security-comprehensive, compliance-check]
    
    steps:
      - name: ğŸ“Š Generate PR Summary
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## ğŸ” Terraform Validation Summary
            
            | Check | Status |
            |-------|--------|
            | ğŸ¨ Code Format | ${{ needs.code-quality.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
            | âœ… Environment Validation | ${{ needs.validate-environments.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
            | ğŸ” Security Scan | ${{ needs.security-comprehensive.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
            | ğŸ“‹ Compliance Check | ${{ needs.compliance-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
            
            ${{ needs.code-quality.result == 'success' && needs.validate-environments.result == 'success' && needs.security-comprehensive.result == 'success' && needs.compliance-check.result == 'success' && 'ğŸ‰ **All checks passed!** This PR is ready for review.' || 'âš ï¸ **Some checks failed.** Please review the issues above before merging.' }}
            
            ---
            *Generated by [Terraform Validation](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });