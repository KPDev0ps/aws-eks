name: "ðŸš€ Terraform Apply"

run-name: "ðŸš€ Apply: ${{ github.event.head_commit.message || github.event.inputs.environments }} - SHA: ${{ github.sha }} [by @${{ github.actor }}]"

on:
  push:
    branches: [main]
    paths:
      - 'terraform/**'
      - '.github/workflows/**'
      - '.github/actions/**'
  
  workflow_dispatch:
    inputs:
      environments:
        description: 'Environments to apply (comma-separated: dev,staging,prod or "all")'
        required: true
        default: 'dev'
        type: string

permissions:
  id-token: write
  contents: read
  pull-requests: write
  issues: write
  checks: write

env:
  AWS_REGION: us-east-2
  TF_VERSION: "1.8.0"

concurrency:
  group: terraform-apply-${{ github.ref }}
  cancel-in-progress: false

jobs:
  detect-changes:
    name: "ðŸ” Detect Changes"
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.get-changes.outputs.matrix }}
      has_changes: ${{ steps.get-changes.outputs.has_changes }}
      environments: ${{ steps.get-changes.outputs.environments }}
      source_branch: ${{ steps.branch-info.outputs.source_branch }}
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ” Get source branch info
        id: branch-info
        run: |
          # Extract source branch from merge commit message or use current branch
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            # Try to extract source branch from merge commit
            source_branch=$(git log -1 --pretty=format:"%s" | grep -oP "Merge pull request #\d+ from [\w-]+/\K[\w-]+" || echo "")
            if [ -z "$source_branch" ]; then
              # Fallback: get the branch that was just merged
              source_branch=$(git log --merges -1 --pretty=format:"%P" | cut -d' ' -f2 | xargs git name-rev --name-only | sed 's/^origin\///')
            fi
          else
            source_branch=""
          fi
          
          echo "source_branch=$source_branch" >> $GITHUB_OUTPUT
          echo "ðŸ” Detected source branch: $source_branch"
      
      - name: ðŸŽ¯ Get changed Terraform directories
        id: get-changes
        uses: ./.github/actions/tf-matrix
        with:
          filter: terraform/aws/overlay/**
      
      - name: ðŸ› ï¸ Handle manual workflow dispatch
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ðŸš€ Manual apply workflow dispatch detected"
          
          # Parse environments input
          if [ "${{ github.event.inputs.environments }}" = "all" ]; then
            environments='["dev","staging","prod"]'
          else
            # Convert comma-separated to JSON array
            envs=$(echo "${{ github.event.inputs.environments }}" | tr ',' '\n' | sed 's/^/"/;s/$/"/' | paste -sd,)
            environments="[$envs]"
          fi
          
          # Build matrix for manual dispatch
          matrix_items=""
          for env in $(echo "$environments" | jq -r '.[]'); do
            if [ ! -z "$matrix_items" ]; then
              matrix_items="$matrix_items,"
            fi
            matrix_items="$matrix_items{\"environment\":\"$env\",\"terraform_dir\":\"terraform/aws/overlay/$env/eks\"}"
          done
          
          matrix_json="{\"include\":[$matrix_items]}"
          
          echo "ðŸŽ¯ Manual dispatch matrix: $matrix_json"
          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "environments=$environments" >> $GITHUB_OUTPUT

  terraform-plan:
    name: "ðŸ“‹ Plan (${{ matrix.environment }})"
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ›¡ï¸ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: "${{ secrets.OIDC_ROLE_ARN }}"
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 3600
      
      - name: ðŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
      
      - name: ðŸ“‹ Cache Terraform
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-terraform-${{ matrix.environment }}-${{ hashFiles(format('{0}/.terraform.lock.hcl', matrix.terraform_dir)) }}
          restore-keys: |
            ${{ runner.os }}-terraform-${{ matrix.environment }}-
      
      - name: ðŸ”§ Terraform Init
        working-directory: ${{ matrix.terraform_dir }}
        run: |
          echo "ðŸ”§ Initializing Terraform for ${{ matrix.environment }}..."
          terraform init
      
      - name: ðŸ“‹ Terraform Plan
        id: plan
        working-directory: ${{ matrix.terraform_dir }}
        run: |
          echo "ðŸ“‹ Creating Terraform plan for ${{ matrix.environment }}..."
          
          terraform plan \
            -detailed-exitcode \
            -out=tfplan-${{ matrix.environment }}-${{ github.run_number }}.tfplan \
            -input=false
          
          exit_code=$?
          echo "exitcode=$exit_code" >> $GITHUB_OUTPUT
          
          # Generate human-readable plan output
          terraform show -no-color tfplan-${{ matrix.environment }}-${{ github.run_number }}.tfplan > plan-output.txt
          
          if [ $exit_code -eq 1 ]; then
            echo "âŒ Plan failed for ${{ matrix.environment }}"
            exit 1
          elif [ $exit_code -eq 2 ]; then
            echo "ðŸ“‹ Plan shows changes for ${{ matrix.environment }} - will proceed to apply after approval"
          else
            echo "âœ… No changes needed for ${{ matrix.environment }} - skipping apply"
          fi
      
      - name: ðŸ“¤ Upload Plan Artifact
        if: steps.plan.outputs.exitcode == '2'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ matrix.environment }}-${{ github.run_number }}
          path: |
            ${{ matrix.terraform_dir }}/tfplan-${{ matrix.environment }}-${{ github.run_number }}.tfplan
            ${{ matrix.terraform_dir }}/plan-output.txt
          retention-days: 30
      
      - name: ðŸ“Š Plan Summary
        working-directory: ${{ matrix.terraform_dir }}
        run: |
          echo "## ðŸ“‹ Plan Summary: ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Exit Code:** ${{ steps.plan.outputs.exitcode }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.plan.outputs.exitcode }}" = "2" ]; then
            echo "**Status:** âš ï¸ Changes detected - waiting for approval to apply" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ Plan Output Preview:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            head -n 50 plan-output.txt >> $GITHUB_STEP_SUMMARY || echo "No plan output available" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âœ… No changes needed" >> $GITHUB_STEP_SUMMARY
          fi

  terraform-apply:
    name: "ðŸš€ Apply (${{ matrix.environment }}) - Requires Approval"
    runs-on: ubuntu-latest
    needs: [detect-changes, terraform-plan]
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    # IMPORTANT: Environment protection enforces approval BEFORE apply
    # Approval happens after plan is visible (from terraform-plan job)
    # - dev: Optional approval (can be immediate)
    # - staging: Requires 1 approval before apply
    # - prod: Requires 2 approvals + 10-minute wait before apply
    # Configure in: Repository Settings â†’ Environments â†’ [env] â†’ Protection rules
    environment: 
      name: ${{ matrix.environment }}
      url: "https://console.aws.amazon.com/eks/home?region=${{ env.AWS_REGION }}#/clusters"
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ›¡ï¸ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: "${{ secrets.OIDC_ROLE_ARN }}"
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 3600
      
      - name: ðŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
      
      - name: ðŸ“‹ Cache Terraform
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-terraform-${{ matrix.environment }}-${{ hashFiles(format('{0}/.terraform.lock.hcl', matrix.terraform_dir)) }}
          restore-keys: |
            ${{ runner.os }}-terraform-${{ matrix.environment }}-
      
      - name: ðŸ“¥ Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-${{ matrix.environment }}-${{ github.run_number }}
          path: ${{ matrix.terraform_dir }}
      
      - name: ðŸ”§ Terraform Init
        working-directory: ${{ matrix.terraform_dir }}
        run: |
          echo "ðŸ”§ Initializing Terraform for ${{ matrix.environment }}..."
          terraform init
      
      - name: ðŸš€ Terraform Apply
        id: apply
        working-directory: ${{ matrix.terraform_dir }}
        run: |
          echo "ðŸš€ Applying Terraform plan for ${{ matrix.environment }}..."
          echo "âš ï¸ This step runs AFTER approval was granted"
          
          plan_file="tfplan-${{ matrix.environment }}-${{ github.run_number }}.tfplan"
          
          if [ ! -f "$plan_file" ]; then
            echo "âŒ Plan file $plan_file not found"
            exit 1
          fi
          
          terraform apply \
            -input=false \
            -auto-approve \
            "$plan_file"
          
          echo "âœ… Apply completed successfully for ${{ matrix.environment }}"
          echo "applied=true" >> $GITHUB_OUTPUT
      
      - name: ðŸ“Š Post-Apply Summary
        if: steps.apply.outputs.applied == 'true'
        working-directory: ${{ matrix.terraform_dir }}
        run: |
          echo "## âœ… Apply Summary: ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Successfully applied" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${{ matrix.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**AWS Region:** \`${{ env.AWS_REGION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Terraform Directory:** \`${{ matrix.terraform_dir }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get cluster info if EKS cluster was created/updated
          if terraform output -json cluster_name > /dev/null 2>&1; then
            cluster_name=$(terraform output -raw cluster_name 2>/dev/null || echo "unknown")
            if [ "$cluster_name" != "unknown" ] && [ ! -z "$cluster_name" ]; then
              echo "**EKS Cluster:** \`$cluster_name\`" >> $GITHUB_STEP_SUMMARY
              echo "**Console:** [View in AWS Console](https://console.aws.amazon.com/eks/home?region=${{ env.AWS_REGION }}#/clusters/$cluster_name)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**kubectl setup:**" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
              echo "aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name $cluster_name" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  cleanup-source-branch:
    name: "ðŸ§¹ Cleanup Source Branch"
    runs-on: ubuntu-latest
    needs: [detect-changes, terraform-plan, terraform-apply]
    if: |
      always() && 
      needs.detect-changes.outputs.source_branch != '' &&
      needs.terraform-apply.result == 'success' &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main'
    
    steps:
      - name: ðŸ§¹ Delete Source Branch
        run: |
          source_branch="${{ needs.detect-changes.outputs.source_branch }}"
          
          if [ -z "$source_branch" ] || [ "$source_branch" = "main" ] || [ "$source_branch" = "master" ]; then
            echo "âš ï¸ Skipping branch deletion: '$source_branch' is protected or empty"
            exit 0
          fi
          
          echo "ðŸ§¹ Attempting to delete source branch: $source_branch"
          
          # Delete remote branch
          if curl -s -X DELETE \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/git/refs/heads/$source_branch"; then
            echo "âœ… Successfully deleted branch: $source_branch"
          else
            echo "âš ï¸ Could not delete branch: $source_branch (may already be deleted or protected)"
          fi

  apply-summary:
    name: "ðŸ“Š Apply Summary"
    runs-on: ubuntu-latest
    needs: [detect-changes, terraform-plan, terraform-apply, cleanup-source-branch]
    if: always() && needs.detect-changes.outputs.has_changes == 'true'
    
    steps:
      - name: ðŸ“Š Generate Final Summary
        run: |
          echo "## ðŸš€ Terraform Apply Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          plan_result="${{ needs.terraform-plan.result }}"
          apply_result="${{ needs.terraform-apply.result }}"
          cleanup_result="${{ needs.cleanup-source-branch.result }}"
          
          # Plan status
          if [ "$plan_result" = "success" ]; then
            echo "### âœ… Plan Status: Successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Plan Status: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Apply status
          if [ "$apply_result" = "success" ]; then
            echo "### âœ… Apply Status: Successful" >> $GITHUB_STEP_SUMMARY
          elif [ "$apply_result" = "skipped" ]; then
            echo "### â­ï¸ Apply Status: Skipped (no changes detected)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Apply Status: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Cleanup status
          if [ "$cleanup_result" = "success" ]; then
            echo "### ðŸ§¹ Branch Cleanup: âœ… Source branch deleted" >> $GITHUB_STEP_SUMMARY
          elif [ "$cleanup_result" = "skipped" ]; then
            echo "### ðŸ§¹ Branch Cleanup: â­ï¸ Skipped (no source branch detected)" >> $GITHUB_STEP_SUMMARY
          elif [ "$cleanup_result" = "failure" ]; then
            echo "### ðŸ§¹ Branch Cleanup: âš ï¸ Failed (branch may be protected)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Processed Environments:" >> $GITHUB_STEP_SUMMARY
          
          environments=$(echo '${{ needs.detect-changes.outputs.environments }}' | jq -r '.[]')
          for env in $environments; do
            echo "- \`$env\`" >> $GITHUB_STEP_SUMMARY
          done
          
          source_branch="${{ needs.detect-changes.outputs.source_branch }}"
          if [ ! -z "$source_branch" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Source Branch:** \`$source_branch\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY