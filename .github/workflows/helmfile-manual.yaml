name: Helmfile Manual
run-name: >-
  ${{ inputs.environment }}: helmfile ${{ inputs.action }} @ ${{ inputs.working_directory }}

on:
  workflow_dispatch:
   inputs:
      cloud-provider:
        description: >-
          cloud-provider (Required):
          cloud provider
        type: choice
        required: true
        default: aws
        options:
          - aws
          # - azure # TODO: add azure kubeconfig update

      environment:
        description: >-
          environment (Required):
          environment type
        type: choice
        required: true
        default: sandbox
        options:
          - nam-dev
          - nam-sit
          - nam-prod
          - us-dev
          - us-devops

      action:
        description: >-
          action (Required):
          helmfile action
        type: choice
        required: true
        default: template
        options:
          - template
          - diff
          - sync
          # - destroy

      force: # feature-flag while we are migrating helm-release to gitops
        description: >-
          force (Optional):
          force helmfile action
        type: boolean
        default: false

      working_directory:
        description: >-
          working_directory (Required):
          Targeted Directory which
          helmfile will be executed
        type: string
        required: true
        default: helmfile/argocd-core

permissions:
  id-token: write   # This is required for requesting the JWT
  contents: read    # This is required for actions/checkout

jobs:
  helmfile:
    name: "${{ inputs.cloud-provider }}-${{ inputs.environment }}-helmfile"
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    defaults:
      run:
        shell: bash

    steps:
      - name: Git clone the repository
        uses: actions/checkout@v4

      - name: Get Environment
        id: get-env
        uses: ./.github/actions/get-env-helmfile
        with:
          environment: ${{ inputs.environment }}

      - name: configure aws credentials
        uses: aws-actions/configure-aws-credentials@v4.0.2
        with:
          role-to-assume: arn:aws:iam::${{ steps.get-env.outputs.aws_account_id }}:role/FutureSecureAI-Admin-GitHub-actions-runner
          aws-region: ap-southeast-2

      - uses: helmfile/helmfile-action@v2.0.4
        with:
          helmfile-version: v1.1.0
          helm-version: v3.18.0
          helm-plugins: >
            https://github.com/databus23/helm-diff

      - name: Update kube config
        id: kube-config
        run: |
          aws eks update-kubeconfig --name ${{ inputs.environment }}-cluster --region ${{ steps.get-env.outputs.aws_region }}
          cluster_name=$(basename "$(kubectl config current-context)")

          echo "cluster_name=$cluster_name" | tee -a $GITHUB_OUTPUT

      - name: helmfile
        working-directory: ${{ inputs.working_directory }}
        env:
          reference_file: ${{ github.workspace }}/helmfile/argocd-core/values/${{ inputs.cloud-provider }}/${{ steps.kube-config.outputs.cluster_name }}.yaml
        run: |
          # step: helmfile

          helmfile_envs=($(
            yq -r '.repoServer.extraContainers[].env[]
              | select( ( .name | test("^HELMFILE_") ) | not )
              | "\(.name)=\(.value)"' $reference_file
          ))

          for i in "${helmfile_envs[@]}"; do echo $i; export $i; done

          if [[ "${{ inputs.force }}" != "true" ]]; then
            if [[ ${{ inputs.working_directory }} != "helmfile/argocd-core" && ${{ inputs.action }} != "template" ]]; then
              # All apps were managed via ARGOCD, only argocd-core is applied/sync via helmfile.
              echo "ðŸ”´ Helmfile ${{ inputs.action }} not allowed in ${{ inputs.working_directory }}, Please Use ArgoCD"
              exit 1
            fi
          fi

          helmfile ${{ inputs.action }}
