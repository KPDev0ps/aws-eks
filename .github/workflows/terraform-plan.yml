name: "ğŸ“‹ Terraform Plan"

run-name: "ğŸ“‹ Plan #${{ github.run_number }} - ${{ github.event_name }} - @${{ github.actor }}"

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main]
    paths:
      - 'terraform/**'
      - '.github/workflows/**'
      - '.github/actions/**'
  
  workflow_dispatch:
    inputs:
      environments:
        description: 'Environments to plan (comma-separated: dev,staging,prod or "all")'
        required: true
        default: 'dev'
        type: string

permissions:
  id-token: write
  contents: read
  pull-requests: write
  issues: write
  checks: write

env:
  AWS_REGION: us-east-2
  TF_VERSION: "1.8.0"

concurrency:
  group: terraform-plan-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    name: "ğŸ” Detect Changes"
    runs-on: ubuntu-latest
    # Skip if PR is in draft state
    if: github.event.pull_request.draft == false || github.event_name == 'workflow_dispatch'
    outputs:
      matrix: ${{ steps.manual-dispatch.outputs.matrix || steps.get-changes.outputs.matrix }}
      has_changes: ${{ steps.manual-dispatch.outputs.has_changes || steps.get-changes.outputs.has_changes }}
      environments: ${{ steps.manual-dispatch.outputs.environments || steps.get-changes.outputs.environments }}
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ¯ Get changed Terraform directories
        id: get-changes
        uses: ./.github/actions/tf-matrix
        with:
          filter: terraform/aws/overlay/**
      
      - name: ğŸ› ï¸ Handle manual workflow dispatch
        id: manual-dispatch
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸ“‹ Manual workflow dispatch detected"
          
          # Install jq if not available
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          
          # Parse environments input
          if [ "${{ github.event.inputs.environments }}" = "all" ]; then
            environments='["dev","staging","prod"]'
          else
            # Convert comma-separated to JSON array, handling spaces and empty values
            input_envs="${{ github.event.inputs.environments }}"
            
            # Clean up input: remove spaces, convert to lowercase
            cleaned_envs=$(echo "$input_envs" | tr ',' '\n' | xargs | tr ' ' '\n' | grep -v '^$' | sort -u)
            
            if [ -z "$cleaned_envs" ]; then
              echo "âŒ No valid environments provided"
              exit 1
            fi
            
            # Build JSON array
            environments="["
            first=true
            for env in $cleaned_envs; do
              # Validate environment name (only allow alphanumeric and hyphens)
              if [[ ! "$env" =~ ^[a-zA-Z0-9-]+$ ]]; then
                echo "âŒ Invalid environment name: $env"
                exit 1
              fi
              
              if [ "$first" = true ]; then
                first=false
              else
                environments="$environments,"
              fi
              environments="$environments\"$env\""
            done
            environments="$environments]"
          fi
          
          echo "ğŸ“‹ Target environments: $environments"
          
          # Build matrix for manual dispatch
          matrix_items=""
          first_item=true
          
          for env in $(echo "$environments" | jq -r '.[]'); do
            terraform_dir="terraform/aws/overlay/$env/eks"
            
            # Verify the directory exists
            if [ ! -d "$terraform_dir" ]; then
              echo "âŒ Terraform directory does not exist: $terraform_dir"
              exit 1
            fi
            
            if [ "$first_item" = true ]; then
              first_item=false
            else
              matrix_items="$matrix_items,"
            fi
            
            matrix_items="$matrix_items{\"environment\":\"$env\",\"terraform_dir\":\"$terraform_dir\"}"
          done
          
          matrix_json="{\"include\":[$matrix_items]}"
          
          # Validate JSON
          echo "$matrix_json" | jq . > /dev/null || {
            echo "âŒ Invalid matrix JSON generated"
            exit 1
          }
          
          echo "ğŸ¯ Manual dispatch matrix: $matrix_json"
          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "environments=$environments" >> $GITHUB_OUTPUT

      - name: ğŸ› Debug Outputs
        run: |
          echo "## ğŸ› Debug Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Has changes**: ${{ steps.manual-dispatch.outputs.has_changes || steps.get-changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY  
          echo "- **Environments**: ${{ steps.manual-dispatch.outputs.environments || steps.get-changes.outputs.environments }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Matrix**: ${{ steps.manual-dispatch.outputs.matrix || steps.get-changes.outputs.matrix }}" >> $GITHUB_STEP_SUMMARY
          echo ""
          echo "Event name: ${{ github.event_name }}"
          echo "Manual dispatch outputs:"
          echo "  - has_changes: ${{ steps.manual-dispatch.outputs.has_changes }}"
          echo "  - environments: ${{ steps.manual-dispatch.outputs.environments }}"
          echo "  - matrix: ${{ steps.manual-dispatch.outputs.matrix }}"
          echo "Get-changes outputs:"
          echo "  - has_changes: ${{ steps.get-changes.outputs.has_changes }}"
          echo "  - environments: ${{ steps.get-changes.outputs.environments }}"
          echo "  - matrix: ${{ steps.get-changes.outputs.matrix }}"

  terraform-plan:
    name: "ğŸ“‹ Plan: ${{ matrix.environment }} environment"
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.result == 'success' && 
      needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        include: ${{ fromJson(needs.detect-changes.outputs.matrix).include }}
      fail-fast: false
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ›¡ï¸ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: "${{ secrets.OIDC_ROLE_ARN }}"
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 3600
      
      - name: ğŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
      
      - name: ğŸ“‹ Cache Terraform
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-terraform-${{ matrix.environment }}-${{ hashFiles(format('{0}/.terraform.lock.hcl', matrix.terraform_dir)) }}
          restore-keys: |
            ${{ runner.os }}-terraform-${{ matrix.environment }}-
      
      - name: ğŸ”§ Terraform Init
        working-directory: ${{ matrix.terraform_dir }}
        run: |
          echo "ğŸ”§ Initializing Terraform for ${{ matrix.environment }}..."
          terraform init
          
      - name: ğŸ¨ Terraform Format Check
        working-directory: ${{ matrix.terraform_dir }}
        run: |
          echo "ğŸ¨ Checking Terraform format for ${{ matrix.environment }}..."
          if ! terraform fmt -check -diff; then
            echo "âŒ Format check failed for ${{ matrix.environment }}"
            echo "ğŸ’¡ Run: terraform fmt -recursive"
            exit 1
          fi
          
      - name: âœ… Terraform Validate
        working-directory: ${{ matrix.terraform_dir }}
        run: |
          echo "âœ… Validating Terraform configuration for ${{ matrix.environment }}..."
          terraform validate
          
      - name: ğŸ“‹ Terraform Plan
        id: plan
        working-directory: ${{ matrix.terraform_dir }}
        continue-on-error: true
        run: |
          echo "ğŸ“‹ Creating Terraform plan for ${{ matrix.environment }}..."
          
          terraform plan \
            -detailed-exitcode \
            -out=tfplan-${{ matrix.environment }}-${{ github.run_number }}.tfplan \
            -input=false
          
          exit_code=$?
          echo "exitcode=$exit_code" >> $GITHUB_OUTPUT
          
          # Generate human readable plan
          terraform show -no-color tfplan-${{ matrix.environment }}-${{ github.run_number }}.tfplan > plan-output.txt
          
          if [ $exit_code -eq 1 ]; then
            echo "âŒ Plan failed for ${{ matrix.environment }}"
            exit 1
          elif [ $exit_code -eq 2 ]; then
            echo "ğŸ“‹ Plan shows changes for ${{ matrix.environment }}"
          else
            echo "âœ… No changes needed for ${{ matrix.environment }}"
          fi
      
      - name: ğŸ“¤ Upload Plan Artifact
        if: steps.plan.outputs.exitcode == '2'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ matrix.environment }}-${{ github.run_number }}
          path: |
            ${{ matrix.terraform_dir }}/tfplan-${{ matrix.environment }}-${{ github.run_number }}.tfplan
            ${{ matrix.terraform_dir }}/plan-output.txt
          retention-days: 30
      
      - name: ğŸ’¬ Comment Plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let planOutput = "No plan output available";
            const planFilePath = '${{ matrix.terraform_dir }}/plan-output.txt';
            
            try {
              if (fs.existsSync(planFilePath)) {
                planOutput = fs.readFileSync(planFilePath, 'utf8');
              }
            } catch (error) {
              console.log('Could not read plan output:', error);
            }
            
            const truncatedOutput = planOutput.length > 10000 ? 
              planOutput.substring(0, 10000) + '\n\n... (truncated)' : planOutput;
            
            const exitCode = '${{ steps.plan.outputs.exitcode }}';
            let statusEmoji, statusText;
            
            if (exitCode === '0') {
              statusEmoji = 'âœ…';
              statusText = 'No changes detected';
            } else if (exitCode === '2') {
              statusEmoji = 'ğŸ“‹';
              statusText = 'Changes detected - Review required';
            } else {
              statusEmoji = 'âŒ';
              statusText = 'Plan failed';
            }
            
            const comment = `## ${statusEmoji} Terraform Plan: \`${{ matrix.environment }}\`
            
            **Status:** ${statusText}
            **Environment:** \`${{ matrix.environment }}\`
            **Exit Code:** \`${exitCode}\`
            
            <details>
            <summary>ğŸ“Š Plan Output (click to expand)</summary>
            
            \`\`\`terraform
            ${truncatedOutput}
            \`\`\`
            </details>
            
            **Workflow:** [\`${{ github.workflow }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            // Find and update existing comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Terraform Plan: `${{ matrix.environment }}`')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  plan-summary:
    name: "ğŸ“Š Plan Summary"
    runs-on: ubuntu-latest
    needs: [detect-changes, terraform-plan]
    if: always() && needs.detect-changes.outputs.has_changes == 'true'
    
    steps:
      - name: ğŸ“Š Generate Summary
        run: |
          echo "## ğŸ“‹ Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          plan_result="${{ needs.terraform-plan.result }}"
          if [ "$plan_result" = "success" ]; then
            echo "### âœ… Plan Status: Successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Plan Status: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ Environments Processed:" >> $GITHUB_STEP_SUMMARY
          
          environments=$(echo '${{ needs.detect-changes.outputs.environments }}' | jq -r '.[]')
          for env in $environments; do
            echo "- \`$env\`" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Next Steps:" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "- Review the plan output in PR comments" >> $GITHUB_STEP_SUMMARY
            echo "- Get required approvals for the PR" >> $GITHUB_STEP_SUMMARY  
            echo "- Merge to main branch to trigger apply workflow" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Review the plan output above" >> $GITHUB_STEP_SUMMARY
            echo "- Run apply workflow manually if changes look good" >> $GITHUB_STEP_SUMMARY
          fi