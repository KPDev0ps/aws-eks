name: "ğŸ“‹ Terraform Plan"

run-name: "ğŸ“‹ Plan #${{ github.run_number }} - ${{ github.event_name }} - @${{ github.actor }}"

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main]
    paths:
      - 'terraform/**'
      - '.github/workflows/**'
      - '.github/actions/**'
  
  workflow_dispatch:
    inputs:
      environments:
        description: 'Environments to plan (comma-separated: dev,staging,prod or "all")'
        required: true
        default: 'dev'
        type: string

permissions:
  id-token: write
  contents: read
  pull-requests: write
  issues: write
  checks: write

env:
  AWS_REGION: us-east-2
  TF_VERSION: "1.8.0"

concurrency:
  group: terraform-plan-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validation-code-quality:
    name: "ğŸ¨ Code Quality & Format"
    runs-on: ubuntu-latest
    # Skip validation if PR is in draft state
    if: github.event.pull_request.draft == false || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: ğŸ¨ Terraform Format Check
        id: fmt
        run: |
          echo "## ğŸ¨ Terraform Format Check" >> $GITHUB_STEP_SUMMARY
          
          if terraform fmt -check -recursive -diff; then
            echo "âœ… All files are properly formatted" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Files need formatting. Run: \`terraform fmt -recursive\`" >> $GITHUB_STEP_SUMMARY
            echo "::error::Terraform format check failed. Run 'terraform fmt -recursive' to fix."
            exit 1
          fi

  validation-environments:
    name: "âœ… Validate (${{ matrix.environment }})"
    runs-on: ubuntu-latest
    needs: validation-code-quality
    strategy:
      matrix:
        environment: [dev, staging, prod]
      fail-fast: false
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          
      - name: ğŸ¯ Terraform Init
        working-directory: terraform/aws/overlay/${{ matrix.environment }}/eks
        run: |
          terraform init -backend=false
          
      - name: âœ… Terraform Validate
        working-directory: terraform/aws/overlay/${{ matrix.environment }}/eks
        run: |
          terraform validate
          echo "âœ… ${{ matrix.environment }} validation successful" >> $GITHUB_STEP_SUMMARY

  detect-changes:
    name: "ğŸ” Detect Changes"
    runs-on: ubuntu-latest
    # Depends on validation passing
    needs: validation-environments
    outputs:
      matrix: ${{ steps.get-changes.outputs.matrix }}
      has_changes: ${{ steps.get-changes.outputs.has_changes }}
      environments: ${{ steps.get-changes.outputs.environments }}
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ¯ Get changed Terraform directories
        id: get-changes
        uses: ./.github/actions/tf-matrix
        with:
          filter: terraform/aws/overlay/**
      
      - name: ğŸ› ï¸ Handle manual workflow dispatch
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸ“‹ Manual workflow dispatch detected"
          
          # Parse environments input
          if [ "${{ github.event.inputs.environments }}" = "all" ]; then
            environments='["dev","staging","prod"]'
          else
            # Convert comma-separated to JSON array
            envs=$(echo "${{ github.event.inputs.environments }}" | tr ',' '\n' | sed 's/^/"/;s/$/"/' | paste -sd,)
            environments="[$envs]"
          fi
          
          # Build matrix for manual dispatch
          matrix_items=""
          for env in $(echo "$environments" | jq -r '.[]'); do
            if [ ! -z "$matrix_items" ]; then
              matrix_items="$matrix_items,"
            fi
            matrix_items="$matrix_items{\"environment\":\"$env\",\"terraform_dir\":\"terraform/aws/overlay/$env/eks\"}"
          done
          
          matrix_json="{\"include\":[$matrix_items]}"
          
          echo "ğŸ¯ Manual dispatch matrix: $matrix_json"
          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "environments=$environments" >> $GITHUB_OUTPUT

  terraform-plan:
    name: "ğŸ“‹ Plan (${{ matrix.environment }})"
    runs-on: ubuntu-latest
    needs: detect-changes
    # Only run if changes detected and PR is not draft
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ›¡ï¸ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: "${{ secrets.OIDC_ROLE_ARN }}"
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 3600
      
      - name: ğŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
      
      - name: ğŸ“‹ Cache Terraform
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-terraform-${{ matrix.environment }}-${{ hashFiles(format('{0}/.terraform.lock.hcl', matrix.terraform_dir)) }}
          restore-keys: |
            ${{ runner.os }}-terraform-${{ matrix.environment }}-
      
      - name: ğŸ”§ Terraform Init
        working-directory: ${{ matrix.terraform_dir }}
        run: |
          echo "ğŸ”§ Initializing Terraform for ${{ matrix.environment }}..."
          terraform init
          
      - name: ğŸ¨ Terraform Format Check
        working-directory: ${{ matrix.terraform_dir }}
        run: |
          echo "ğŸ¨ Checking Terraform format for ${{ matrix.environment }}..."
          if ! terraform fmt -check -diff; then
            echo "âŒ Format check failed for ${{ matrix.environment }}"
            echo "ğŸ’¡ Run: terraform fmt -recursive"
            exit 1
          fi
          
      - name: âœ… Terraform Validate
        working-directory: ${{ matrix.terraform_dir }}
        run: |
          echo "âœ… Validating Terraform configuration for ${{ matrix.environment }}..."
          terraform validate
          
      - name: ğŸ“‹ Terraform Plan
        id: plan
        working-directory: ${{ matrix.terraform_dir }}
        continue-on-error: true
        run: |
          echo "ğŸ“‹ Creating Terraform plan for ${{ matrix.environment }}..."
          
          terraform plan \
            -detailed-exitcode \
            -out=tfplan-${{ matrix.environment }}-${{ github.run_number }}.tfplan \
            -input=false
          
          exit_code=$?
          echo "exitcode=$exit_code" >> $GITHUB_OUTPUT
          
          # Generate human readable plan
          terraform show -no-color tfplan-${{ matrix.environment }}-${{ github.run_number }}.tfplan > plan-output.txt
          
          if [ $exit_code -eq 1 ]; then
            echo "âŒ Plan failed for ${{ matrix.environment }}"
            exit 1
          elif [ $exit_code -eq 2 ]; then
            echo "ğŸ“‹ Plan shows changes for ${{ matrix.environment }}"
          else
            echo "âœ… No changes needed for ${{ matrix.environment }}"
          fi
      
      - name: ğŸ“¤ Upload Plan Artifact
        if: steps.plan.outputs.exitcode == '2'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ matrix.environment }}-${{ github.run_number }}
          path: |
            ${{ matrix.terraform_dir }}/tfplan-${{ matrix.environment }}-${{ github.run_number }}.tfplan
            ${{ matrix.terraform_dir }}/plan-output.txt
          retention-days: 30
      
      - name: ğŸ’¬ Comment Plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let planOutput = "No plan output available";
            const planFilePath = '${{ matrix.terraform_dir }}/plan-output.txt';
            
            try {
              if (fs.existsSync(planFilePath)) {
                planOutput = fs.readFileSync(planFilePath, 'utf8');
              }
            } catch (error) {
              console.log('Could not read plan output:', error);
            }
            
            const truncatedOutput = planOutput.length > 10000 ? 
              planOutput.substring(0, 10000) + '\n\n... (truncated)' : planOutput;
            
            const exitCode = '${{ steps.plan.outputs.exitcode }}';
            let statusEmoji, statusText;
            
            if (exitCode === '0') {
              statusEmoji = 'âœ…';
              statusText = 'No changes detected';
            } else if (exitCode === '2') {
              statusEmoji = 'ğŸ“‹';
              statusText = 'Changes detected - Review required';
            } else {
              statusEmoji = 'âŒ';
              statusText = 'Plan failed';
            }
            
            const comment = `## ${statusEmoji} Terraform Plan: \`${{ matrix.environment }}\`
            
            **Status:** ${statusText}
            **Environment:** \`${{ matrix.environment }}\`
            **Exit Code:** \`${exitCode}\`
            
            <details>
            <summary>ğŸ“Š Plan Output (click to expand)</summary>
            
            \`\`\`terraform
            ${truncatedOutput}
            \`\`\`
            </details>
            
            **Workflow:** [\`${{ github.workflow }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            // Find and update existing comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Terraform Plan: `${{ matrix.environment }}`')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  plan-summary:
    name: "ğŸ“Š Plan Summary"
    runs-on: ubuntu-latest
    needs: [validation-code-quality, validation-environments, detect-changes, terraform-plan]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Summary
        run: |
          echo "## ğŸ“‹ Terraform Plan Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Validation status
          validation_quality="${{ needs.validation-code-quality.result }}"
          validation_envs="${{ needs.validation-environments.result }}"
          
          echo "### ğŸ” Validation Results:" >> $GITHUB_STEP_SUMMARY
          if [ "$validation_quality" = "success" ]; then
            echo "- âœ… Code Quality & Format: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Code Quality & Format: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$validation_envs" = "success" ]; then
            echo "- âœ… Environment Validation: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Environment Validation: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Plan status
          detect_changes="${{ needs.detect-changes.result }}"
          plan_result="${{ needs.terraform-plan.result }}"
          has_changes="${{ needs.detect-changes.outputs.has_changes }}"
          
          if [ "$detect_changes" = "success" ] && [ "$has_changes" = "true" ]; then
            if [ "$plan_result" = "success" ]; then
              echo "### âœ… Plan Status: Successful" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âŒ Plan Status: Failed" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ¯ Environments Processed:" >> $GITHUB_STEP_SUMMARY
            
            environments=$(echo '${{ needs.detect-changes.outputs.environments }}' | jq -r '.[]')
            for env in $environments; do
              echo "- \`$env\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "### â­ï¸ Plan Status: Skipped (no changes detected)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Next Steps:" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "- Review the plan output in PR comments" >> $GITHUB_STEP_SUMMARY
            echo "- Get required approvals for the PR" >> $GITHUB_STEP_SUMMARY  
            echo "- Merge to main branch to trigger apply workflow" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Review the plan output above" >> $GITHUB_STEP_SUMMARY
            echo "- Run apply workflow manually if changes look good" >> $GITHUB_STEP_SUMMARY
          fi