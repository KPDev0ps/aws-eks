name: 'Get Terraform Changed Directories'
description: 'Detects changed Terraform directories and creates a matrix for parallel execution'
inputs:
  filter:
    description: 'Path filter pattern for Terraform directories'
    required: true
    default: 'terraform/aws/overlay/**'
  base_ref:
    description: 'Base reference for comparison (default: main branch)'
    required: false
    default: 'origin/main'
outputs:
  matrix:
    description: 'JSON matrix of changed environments'
    value: ${{ steps.generate-matrix.outputs.matrix }}
  has_changes:
    description: 'Whether any Terraform files have changed'
    value: ${{ steps.generate-matrix.outputs.has_changes }}
  environments:
    description: 'List of changed environments'
    value: ${{ steps.generate-matrix.outputs.environments }}

runs:
  using: 'composite'
  steps:
    - name: ï¿½ï¸ Install jq
      shell: bash
      run: |
        if ! command -v jq &> /dev/null; then
          echo "Installing jq..."
          sudo apt-get update && sudo apt-get install -y jq
        fi

    - name: ï¿½ðŸ” Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v44
      with:
        files: ${{ inputs.filter }}
        dir_names: true
        dir_names_max_depth: 4
        since_last_remote_commit: true

    - name: ðŸŽ¯ Generate matrix
      id: generate-matrix
      shell: bash
      run: |
        echo "ðŸ” Analyzing changed Terraform directories..."
        
        # Debug: Show all changed files
        echo "ðŸ› All changed files: ${{ steps.changed-files.outputs.all_changed_files }}"
        
        # Get unique environment directories that have changes
        changed_files="${{ steps.changed-files.outputs.all_changed_files }}"
        
        if [ -z "$changed_files" ] || [ "$changed_files" = "" ]; then
          echo "No changed files detected"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
          echo "environments=[]" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Extract environment names from changed directories
        changed_dirs=""
        for file in $changed_files; do
          if [[ "$file" =~ terraform/aws/overlay/([^/]+)/eks ]]; then
            env="${BASH_REMATCH[1]}"
            if [ -n "$env" ] && [[ ! "$changed_dirs" =~ (^|[[:space:]])$env($|[[:space:]]) ]]; then
              changed_dirs="$changed_dirs $env"
            fi
          fi
        done
        
        # Trim leading/trailing spaces
        changed_dirs=$(echo "$changed_dirs" | xargs)
        
        if [ -z "$changed_dirs" ]; then
          echo "No Terraform environment changes detected"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
          echo "environments=[]" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "ðŸ“‚ Changed environments detected:"
        echo "$changed_dirs"
        
        # Build matrix JSON using jq for proper formatting
        matrix_items=""
        environments_array=""
        
        first_item=true
        for env in $changed_dirs; do
          # Validate environment name
          if [ -z "$env" ]; then
            continue
          fi
          
          # Check if terraform directory exists
          terraform_dir="terraform/aws/overlay/$env/eks"
          if [ ! -d "$terraform_dir" ]; then
            echo "âš ï¸ Warning: Directory $terraform_dir does not exist, skipping $env"
            continue
          fi
          
          if [ "$first_item" = true ]; then
            first_item=false
          else
            matrix_items="$matrix_items,"
            environments_array="$environments_array,"
          fi
          
          # Properly escape JSON strings
          matrix_items="$matrix_items{\"environment\":\"$env\",\"terraform_dir\":\"$terraform_dir\"}"
          environments_array="$environments_array\"$env\""
          
          echo "  - $env ($terraform_dir)"
        done
        
        # Validate we have at least one valid environment
        if [ "$first_item" = true ]; then
          echo "No valid Terraform environments found"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
          echo "environments=[]" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        matrix_json="{\"include\":[$matrix_items]}"
        environments_json="[$environments_array]"
        
        # Validate JSON format
        echo "$matrix_json" | jq . > /dev/null || {
          echo "âŒ Invalid matrix JSON generated: $matrix_json"
          exit 1
        }
        
        echo "$environments_json" | jq . > /dev/null || {
          echo "âŒ Invalid environments JSON generated: $environments_json"
          exit 1
        }
        
        echo "ðŸŽ¯ Generated matrix: $matrix_json"
        echo "ðŸ“‹ Environments list: $environments_json"
        
        echo "has_changes=true" >> $GITHUB_OUTPUT
        echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
        echo "environments=$environments_json" >> $GITHUB_OUTPUT

    - name: ðŸ“Š Matrix Summary
      shell: bash
      run: |
        echo "## ðŸ“Š Terraform Changes Detection" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.generate-matrix.outputs.has_changes }}" == "true" ]; then
          echo "### âœ… Changed Environments:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          environments=$(echo '${{ steps.generate-matrix.outputs.environments }}' | jq -r '.[]')
          for env in $environments; do
            echo "- ðŸŽ¯ **$env** (\`terraform/aws/overlay/$env/eks\`)" >> $GITHUB_STEP_SUMMARY
          done
        else
          echo "### â„¹ï¸ No Terraform environment changes detected" >> $GITHUB_STEP_SUMMARY
          echo "No environments will be processed in this workflow run." >> $GITHUB_STEP_SUMMARY
        fi